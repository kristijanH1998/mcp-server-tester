<!DOCTYPE html>
<html>
<head>
  <title>MCP Server Tester</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    textarea, input, select { width: 100%; margin-bottom: 10px; }
    button { margin-bottom: 10px; }
    pre { background: #eee; padding: 10px; }
  </style>
</head>
<body>

<h1>MCP Server Tester</h1>

<h3>Register MCP Server</h3>
<input id="serverUrl" value="http://127.0.0.1:8001/mcp">
<button onclick="registerServer()">Register</button>

<h3>Servers</h3>
<select id="servers" onchange="loadTools()"></select>

<h3>Tools</h3>
<select id="tools"></select>

<h3>Arguments (JSON)</h3>
<textarea id="args">{ "message": "Hello MCP" }</textarea>

<h3>Iterations</h3>
<input id="iterations" type="number" value="10">

<button onclick="runExperiment()">Run Experiment</button>

<h3>Result</h3>
<pre id="result"></pre>

<h3>Load Saved Experiment</h3>
<input id="experimentId" placeholder="Paste experiment ID here" />
<button onclick="loadExperiment()">Load</button>

<script>
const BASE = "http://127.0.0.1:8000";

async function registerServer() {
  await fetch(`${BASE}/servers`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      url: document.getElementById("serverUrl").value
    })
  });

  await loadServers(); // triggers tool loading
}

async function loadServers() {
  const res = await fetch(`${BASE}/servers`);
  const servers = await res.json();
  const sel = document.getElementById("servers");

  sel.innerHTML = "";

  const ids = Object.keys(servers);
  if (ids.length === 0) {
    return;
  }

  for (const id of ids) {
    const opt = document.createElement("option");
    opt.value = id;
    opt.textContent = `${id.slice(0, 8)} â†’ ${servers[id]}`;
    sel.appendChild(opt);
  }

  // ðŸ”¥ CRITICAL FIX:
  // Select first server and load tools explicitly
  sel.value = ids[0];
  await loadTools();
}

async function loadTools() {
  const serverId = document.getElementById("servers").value;
  const res = await fetch(`${BASE}/servers/${serverId}/tools`);
  const tools = await res.json();
  const sel = document.getElementById("tools");
  sel.innerHTML = "";
  tools.forEach(t => {
    const opt = document.createElement("option");
    opt.value = t.name;
    opt.textContent = t.name;
    sel.appendChild(opt);
  });
}

async function runExperiment() {
  const res = await fetch(`${BASE}/experiments`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      server_id: document.getElementById("servers").value,
      tool: document.getElementById("tools").value,
      arguments: JSON.parse(document.getElementById("args").value),
      iterations: parseInt(document.getElementById("iterations").value)
    })
  });

  const data = await res.json();

  const url = `${BASE}/experiments/${data.experiment_id}`;

  document.getElementById("result").innerHTML = `
Experiment ID: ${data.experiment_id}

View URL:
${url}

Result:
${JSON.stringify(data, null, 2)}
  `;
}

async function loadExperiment() {
  const id = document.getElementById("experimentId").value.trim();
  if (!id) return;

  const res = await fetch(`${BASE}/experiments/${id}`);
  const data = await res.json();

  document.getElementById("result").textContent =
    JSON.stringify(data, null, 2);
}

loadServers();
</script>

</body>
</html>



